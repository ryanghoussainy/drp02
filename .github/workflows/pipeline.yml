name: CI/CD Pipeline

on:
  push:
    branches: [master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Dependencies
        run: npm install
        working-directory: team-up-london

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: EAS Build (Android & iOS)
        run: |
          eas build -p android --profile preview --non-interactive --json > android.json
          eas build -p ios --profile preview --non-interactive --json > ios.json
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        working-directory: team-up-london

      - name: Extract APK & IPA Download URLs
        run: |
          echo "ANDROID_URL=$(jq -r '.artifacts.buildUrl' android.json)" >> $GITHUB_ENV
          echo "IOS_URL=$(jq -r '.artifacts.buildUrl' ios.json)" >> $GITHUB_ENV
        working-directory: team-up-london

      - name: Generate Public Dashboard to Download Links
        run: |
          cat <<EOF > index.html
          <html>
          <head><title>🏀 Social Sports App Downloads</title></head>
          <body style="font-family:sans-serif; text-align:center; padding-top:50px;">
            <h1>🏀 Download Our App</h1>
            <p><a href="$ANDROID_URL">📱 Download Android APK</a></p>
            <p><a href="$IOS_URL">🍏 Download iOS IPA</a></p>
          </body>
          </html>
          EOF
        working-directory: website

      - name: Deploy Website to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: website
          alias-domains: drp02.vercel.app
